<div class="space-y-6">
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
    <h1 class="text-3xl font-bold">Inventario</h1>

    <div class="flex gap-2">
      <select class="select select-bordered w-full max-w-xs" [ngModel]="filterCategory()" (ngModelChange)="filterCategory.set($event)">
        <option value="">Todas las Categorías</option>
        <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
      </select>

      <select class="select select-bordered w-full max-w-xs" [ngModel]="filterLocation()" (ngModelChange)="filterLocation.set($event)">
        <option value="">Todas las Ubicaciones</option>
        <option *ngFor="let loc of locations" [value]="loc">{{ loc === 'fridge' ? 'Nevera' : 'Despensa' }}</option>
      </select>

      <a routerLink="/add" class="btn btn-primary">
         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
         Agregar
      </a>
    </div>
  </div>

  <div class="overflow-x-auto bg-base-100 shadow-xl rounded-box">
    <table class="table w-full">
      <thead>
        <tr>
          <th>Estado</th>
          <th>Nombre</th>
          <th>Ubicación</th>
          <th>Categoría</th>
          <th>Vence</th>
          <th class="text-right">Acciones</th>
        </tr>
      </thead>
      <tbody>
        @for (item of filteredItems(); track item.id) {
        <tr [class.opacity-50]="item.status === 'consumed' || item.status === 'expired'">
          <td>
             <div class="badge h-full" [ngClass]="{
               'badge-success': item.status === 'fresh',
               'badge-warning': item.status === 'expiring',
               'badge-neutral': item.status === 'consumed',
               'badge-error': item.status === 'expired'
             }">
               @switch (item.status) {
                 @case ('fresh') { Fresco }
                 @case ('expiring') { Por vencer }
                 @case ('consumed') { Consumido }
                 @case ('expired') { Vencido }
               }
             </div>
          </td>
          <td>
            <div class="font-bold">{{ item.name }}</div>
            <div class="text-xs">Qty: {{ item.quantity }}</div>
            <div *ngIf="item.createdBy" class="text-[10px] text-base-content/60">
                Agregado por: {{ item.createdBy }}
            </div>
          </td>
          <td>{{ item.location === 'fridge' ? 'Nevera' : 'Despensa' }}</td>
          <td>{{ item.category }}</td>
          <td>
            @if (item.expirationDate) {
               {{ item.expirationDate | date:'dd/MM/yyyy':'UTC' }}
            } @else {
              <span class="text-base-content/30">--</span>
            }
          </td>
          <td class="text-right space-x-2">
             @if (item.status === 'fresh' || item.status === 'expiring') {
             <button class="btn btn-xs btn-success btn-outline"
                     (click)="markAsConsumed(item.id)"
                     title="Marcar como Consumido">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
             </button>
             }

             @if (item.status === 'consumed') {
             <button class="btn btn-xs btn-warning btn-outline"
                     (click)="restoreItem(item.id)"
                     title="Restaurar / Regresar al inventario">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" /></svg>
             </button>
             }

             @if (item.status === 'fresh' || item.status === 'expired' || item.status === 'expiring' || item.status === 'consumed') {
             <button class="btn btn-xs btn-info btn-outline"
                     (click)="startEdit(item)"
                     title="Editar">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
             </button>
             }
             <button class="btn btn-xs btn-error btn-ghost" (click)="deleteItem(item.id)" title="Eliminar">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
             </button>
          </td>
        </tr>
        } @empty {
        <tr>
          <td colspan="6" class="text-center py-8 text-base-content/50">
            No se encontraron productos con los filtros seleccionados.
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- Edit Modal -->
  <dialog class="modal" [class.modal-open]="editingItem()">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">Editar Producto</h3>

      <form [formGroup]="editForm" (ngSubmit)="saveEdit()" class="space-y-4">
        <div class="form-control">
          <label class="label"><span class="label-text">Nombre del Alimento</span></label>
          <input type="text" formControlName="name" placeholder="Ej: Manzanas, Leche..." class="input input-bordered w-full" />
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="form-control">
            <label class="label"><span class="label-text">Categoría</span></label>
            <select formControlName="category" class="select select-bordered w-full">
              <option value="" disabled>Seleccionar...</option>
              <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
            </select>
          </div>

          <div class="form-control">
            <label class="label"><span class="label-text">Ubicación</span></label>
            <select formControlName="location" class="select select-bordered w-full">
              <option *ngFor="let loc of locations" [value]="loc">{{ loc === 'fridge' ? 'Nevera' : 'Despensa' }}</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="form-control">
            <label class="label"><span class="label-text">Cantidad</span></label>
            <input type="number" formControlName="quantity" class="input input-bordered w-full" min="1" />
          </div>

          <div class="form-control">
            <label class="label"><span class="label-text">Fecha de Vencimiento (Opcional)</span></label>
            <input type="date" formControlName="expirationDate" class="input input-bordered w-full" />
          </div>
        </div>

        <div class="modal-action">
          <button type="button" class="btn btn-ghost" (click)="cancelEdit()">Cancelar</button>
          <button type="submit" class="btn btn-primary" [disabled]="editForm.invalid">Guardar Cambios</button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button (click)="cancelEdit()">close</button>
    </form>
  </dialog>
</div>
